# 系统架构总览

天机爻平台采用现代化的微服务架构，结合无服务器（Serverless）技术，实现高性能、高可用、易扩展的 AI 命理分析服务。

## 架构设计理念

### 核心原则

- **前后端分离**：前端使用 Next.js SSR/SSG，后端使用 Azure Functions 无服务器架构
- **AI 驱动**：核心业务逻辑由 OpenAI GPT 模型提供智能解读
- **微服务化**：功能模块独立部署，互不影响
- **边缘计算**：利用 Vercel Edge Functions 实现全球低延迟访问
- **数据安全**：多层加密，符合 GDPR 隐私规范

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层 (User Layer)                      │
│  Web 浏览器 / 移动浏览器 / 微信小程序 / PWA                      │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      前端层 (Frontend Layer)                     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐ │
│  │   Next.js 14     │  │  React 18        │  │  Tailwind CSS │ │
│  │   (SSR/SSG)      │  │  (UI Components) │  │  (Styling)    │ │
│  └──────────────────┘  └──────────────────┘  └───────────────┘ │
│                                                                  │
│  部署：Vercel (Edge Network) + Cloudflare CDN                   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 网关层 (API Gateway)                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Azure API Management / Vercel Edge Functions            │  │
│  │  • 路由转发 • 限流控制 • 身份验证 • 请求日志              │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  八字排盘     │  │  紫微斗数     │  │  AI 合盘     │
│  微服务       │  │  微服务       │  │  微服务      │
│  (Azure      │  │  (Azure      │  │  (Azure     │
│  Functions)  │  │  Functions)  │  │  Functions) │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      AI 引擎层 (AI Engine Layer)                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  OpenAI GPT-4 / GPT-4 Turbo                              │  │
│  │  • 命理解读 • 性格分析 • 运势预测 • 合盘匹配              │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Azure Cognitive Services                                 │  │
│  │  • 语音合成 (TTS) • 情感分析 • 翻译服务                   │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层 (Data Layer)                         │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐ │
│  │   Supabase       │  │   MongoDB        │  │  Redis Cache  │ │
│  │   (PostgreSQL)   │  │   (NoSQL)        │  │  (缓存)       │ │
│  │  • 用户数据       │  │  • 历史记录      │  │  • 热点数据   │ │
│  │  • 订单数据       │  │  • 日志数据      │  │  • Session    │ │
│  └──────────────────┘  └──────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 技术架构详解

### 1. 前端架构

- **框架**：Next.js 14 (App Router)
- **渲染策略**：
  - 首页、博客：静态生成 (SSG)
  - 占卜页面：服务端渲染 (SSR)
  - 个人中心：客户端渲染 (CSR)
- **状态管理**：Zustand + React Context
- **UI 组件库**：shadcn/ui + Radix UI
- **样式方案**：Tailwind CSS + CSS Modules

[详细了解前端架构 →](/architecture/frontend)

### 2. 后端架构

- **计算层**：Azure Functions (Node.js 18)
- **API 设计**：RESTful API
- **身份验证**：JWT + Supabase Auth
- **消息队列**：Azure Service Bus
- **文件存储**：Azure Blob Storage

[详细了解后端架构 →](/architecture/backend)

### 3. AI 引擎

- **核心模型**：OpenAI GPT-4 Turbo
- **Prompt 工程**：结构化命理知识库 + Few-shot Learning
- **向量数据库**：Pinecone (存储命理知识嵌入)
- **模型优化**：上下文压缩、流式输出、缓存策略

[详细了解 AI 引擎 →](/architecture/ai-engine)

### 4. 数据架构

- **主数据库**：Supabase (PostgreSQL)
  - 用户信息、订单、权限
- **文档数据库**：MongoDB
  - 占卜历史、日志、分析记录
- **缓存层**：Redis
  - 热点数据缓存、Session 管理

[详细了解数据库设计 →](/architecture/database)

## 部署架构

### 生产环境

```
全球用户
    ↓
Cloudflare CDN (全球加速)
    ↓
Vercel Edge Network (前端)
    ↓
Azure API Management (API 网关)
    ↓
Azure Functions (业务逻辑)
    ↓
Supabase / MongoDB (数据存储)
```

### 多区域部署

- **主区域**：Azure East Asia (香港)
- **备用区域**：Azure Southeast Asia (新加坡)
- **CDN 节点**：全球 300+ 节点

## 性能指标

| 指标 | 目标 | 当前表现 |
|------|------|---------|
| 首屏加载 (LCP) | < 2.5s | 1.8s |
| 交互延迟 (FID) | < 100ms | 65ms |
| 布局稳定性 (CLS) | < 0.1 | 0.05 |
| API 响应时间 | < 500ms | 320ms |
| AI 解读时间 | < 5s | 3.2s |
| 系统可用性 | > 99.9% | 99.95% |

## 扩展性设计

### 水平扩展

- **前端**：Vercel 自动扩展
- **后端**：Azure Functions 按需扩展（最多 200 实例）
- **数据库**：Supabase 支持读写分离

### 垂直扩展

- **缓存优化**：Redis 集群
- **CDN 加速**：静态资源全球分发
- **数据库索引**：优化查询性能

## 监控与运维

- **性能监控**：Azure Application Insights
- **错误追踪**：Sentry
- **日志分析**：Azure Log Analytics
- **告警系统**：PagerDuty

## 安全架构

- **HTTPS**：全站强制 SSL/TLS
- **身份验证**：OAuth 2.0 + JWT
- **数据加密**：AES-256 加密存储
- **DDoS 防护**：Cloudflare Pro
- **隐私合规**：GDPR、CCPA

## 下一步

- [前端架构详解](/architecture/frontend)
- [后端架构详解](/architecture/backend)
- [AI 引擎设计](/architecture/ai-engine)
- [数据库设计](/architecture/database)

---

::: tip 💡 想要了解更多？
访问 [技术博客](/blog/) 阅读深度技术文章，或查看 [API 文档](/api/) 了解接口设计。
:::
